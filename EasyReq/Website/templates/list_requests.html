{% extends 'base.html' %}
{% load static %}

{% block title %}ניהול בקשות | EasyReq{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/tablesort@5.2.1/dist/tablesort.min.js"></script>

<style>
  body {
    background-color: #eaf0fb;
    font-family: 'Calibri', sans-serif;
    direction: rtl;
  }

  .container-box {
    max-width: 1200px;
    margin: 20px auto;
    background: #fff;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 12px 40px rgba(46, 70, 122, 0.7);
  }

  .section-title {
    font-size: 28px;
    font-weight: bold;
    color: #2d6cdf;
    margin-bottom: 30px;
    text-align: center;
  }

  

  .table-responsive {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    direction: rtl;
    text-align: right;
    background-color: #fff;
  }

  thead th {
    background-color: #f2f4f8;
    border: 1px solid #ccc;
    padding: 12px;
    cursor: pointer;
    position: relative;
  }

  thead th::after {
    content: " \f0dc";
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #666;
  }

  tbody td {
    border: 1px solid #ccc;
    padding: 10px;
    vertical-align: middle;
  }

  .badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    color: white;
    display: inline-block;
  }

  .badge-warning { background-color: #dcd767; }
  .badge-success { background-color: #39a653; }
  .badge-danger { background-color: #e6959c; }
  .badge-secondary { background-color: #909daa; }
  .badge-info { background-color: #17a2b8; }
  .badge-urgent { background-color: #dc3545; }
  .badge-soon { background-color: #ffc107; color: #333; }
  .badge-ok { background-color: #28a745; }

  .btn-sm {
    padding: 4px 10px;
    font-size: 14px;
    border-radius: 6px;
  }

  .btn-outline-edit {
    color: #fd7e14;
    border: 1px solid #fd7e14;
  }

  .btn-outline-edit:hover {
    background-color: #fd7e14;
    color: white;
  }

  .btn-outline-danger {
    color: #dc3545;
    border: 1px solid #dc3545;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
  }

  .mb-4 {
    margin-bottom: 1.5rem;
  }

.filter-bar input,
.filter-bar select {
  font-size: 14px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background-color: #f9f9f9;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: 500;
  border-radius: 8px;
  border: none;
  background-color: #f4f4f4;
  color: #333;
  transition: 0.2s ease;
  text-decoration: none;
}

.action-btn:hover {
  background-color: #e2e6ea;
}

.action-view {
  background-color: #dfefff;
  color: #1464c2;
}

.action-edit {
  background-color: #fff7e6;
  color: #d98300;
}

.action-delete {
  background-color: #fdeaea;
  color: #d33;
}


.label {
  font-size: 13px;
  padding: 5px 10px;
  border-radius: 20px;
  background-color: #f8f9fa;
  border: 1px solid #ccc;
  color: #444;
  display: inline-block;
}

.label-waiting {
  border-color: #ffc107;
  background-color: #fff8e1;
}

.label-approved {
  border-color: #28a745;
  background-color: #e9fbe9;
}

.label-rejected {
  border-color: #dc3545;
  background-color: #fdecea;
}

.label-high {
  border-color: #dc3545;
  background-color: #fbeaea;
}

.label-medium {
  border-color: #ffc107;
  background-color: #fff9e5;
}

.label-low {
  border-color: #17a2b8;
  background-color: #e3f7fb;
}

.label-treated {
  border-color: #adb5bd;
  background-color: #f1f3f5;
}

.label-urgent {
  border-color: #dc3545;
  background-color: #fff0f0;
}

.label-soon {
  border-color: #ffc107;
  background-color: #fffbe6;
}

.label-ok {
  border-color: #28a745;
  background-color: #ebfbee;
}

.text-muted { color: #6c757d; }
.text-success { color: #198754; }
.text-warning { color: #ffc107; }
.text-danger { color: #dc3545; }
.text-primary { color: #0d6efd; }

.btn-link {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 6px;
}

.btn-link:hover i {
  opacity: 0.7;
}


</style>

<div class="container-box">
  <h2 class="section-title">ניהול בקשות</h2>


  {% if user.role == 0 or user.role == 1 %}
  <div class="mb-4 text-end">
    <a href="{% url 'create_request' %}" class="btn btn-primary btn-sm">
      <i class="fas fa-plus me-1"></i> בקשה חדשה
    </a>
  </div>

   <div class="chart-container" style="max-width: 300px; margin: 0 auto 20px;">
  <div 
    style="position: relative; height: 300px; width: 200px; margin: 0 auto;" 
    class="{% if status_counts.0 == 0 and status_counts.1 == 0 and status_counts.2 == 0 %}no-data-chart{% endif %}"
  >
    <canvas id="statusChart"></canvas>
  </div>

  {% if status_counts.0 == 0 and status_counts.1 == 0 and status_counts.2 == 0 %}
    <div style="text-align: center; color: #333; font-size: 20px; margin-top: 5px;">
      No data yet
    </div>
  {% endif %}
</div>


  {% endif %}

  <div class="filter-bar mb-4">
    <input type="text" id="searchTitle" placeholder="חיפוש לפי כותרת..." class="form-control d-inline-block w-auto me-2 mb-2" />

    <select id="statusFilter" class="form-select d-inline-block w-auto me-2 mb-2">
      <option value="">כל הסטטוסים</option>
      <option value="ממתין">ממתין לטיפול</option>
      <option value="מאושר">מאושר</option>
      <option value="נדחה">נדחה</option>
    </select>

    <select id="priorityFilter" class="form-select d-inline-block w-auto me-2 mb-2">
      <option value="">כל רמות הדחיפות</option>
      <option value="גבוהה">גבוהה</option>
      <option value="בינונית">בינונית</option>
      <option value="נמוכה">נמוכה</option>
    </select>
  </div>

  {% if user.role != 0 %}
    <form method="post" action="{% url 'list_requests' %}">
      {% csrf_token %}
      <div class="table-responsive">
        <table id="sortable-table">
          <thead>
            <tr {% if req.status == 0 and "באיחור" in req.get_remaining_days_display %}style="background-color: #fdeaea;"{% endif %}>
              <th>מס'</th>
              <th>שם הסטודנט</th>
              <th>כותרת</th>
              <th>סטטוס</th>
              <th>דחיפות</th>
              <th>זמן לטיפול</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>
          {% for req in page_obj %}
          <tr {% if req.status == 0 and "באיחור" in req.get_remaining_days_display %}style="background-color: #fdeaea;"{% endif %}>
            <td>{{ req.id }}</td>
            <td>{{ req.student.get_full_name }}</td>
            <td>{{ req.get_title_display|truncatechars:30 }}</td>

            <!-- סטטוס -->
            <td>
              {% if req.status == 0 %}
                <i class="fas fa-hourglass-half text-muted"></i> ממתין
              {% elif req.status == 1 %}
                <i class="fas fa-check-circle text-success"></i> מאושר
              {% else %}
                <i class="fas fa-times-circle text-danger"></i> נדחה
              {% endif %}
            </td>

            <!-- דחיפות -->
            <td>
              {% if req.priority == 3 %}
                גבוהה
              {% elif req.priority == 2 %}
              בינונית
              {% else %}
              נמוכה
              {% endif %}
            </td>

            <!-- זמן לטיפול -->
            <td>
              {% if req.status == 0 %}
                {{ req.get_remaining_days_display|safe }}
              {% else %}
                טופל
              {% endif %}
            </td>

            <!-- פעולות -->
            <td>
              <a href="{% url 'request_detail' req.id %}" class="btn btn-link text-decoration-none" title="צפה">
                <i class="fas fa-eye text-primary"></i>
              </a>
              {% if user.role == 1 or user.role == 2 or user.role == 3 %}
              <a href="{% url 'update_request_status' req.id %}" class="btn btn-link text-decoration-none" title="עדכון">
                <i class="fas fa-pen text-warning"></i>
              </a>
              <button type="submit" name="delete_request_id" value="{{ req.id }}" class="btn btn-link text-decoration-none" onclick="return confirm('האם למחוק את הבקשה?');" title="מחק">
                <i class="fas fa-trash text-danger"></i>
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
          </tbody>
        </table>
      </div>
    </form>

  {% else %}
    <form method="post" action="{% url 'list_requests' %}">
      {% csrf_token %}
      <div class="table-responsive">
        <table id="sortable-table">
          <thead>
            <tr {% if req.status == 0 and "באיחור" in req.get_remaining_days_display %}style="background-color: #fdeaea;"{% endif %}>
              <th>מס'</th>
              <th>שם הסטודנט</th>
              <th>כותרת</th>
              <th>סטטוס</th>
              <th>זמן לטיפול</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>
          {% for req in page_obj %}
          <tr {% if req.status == 0 and "באיחור" in req.get_remaining_days_display %}style="background-color: #fdeaea;"{% endif %}>
            <td>{{ req.id }}</td>
            <td>{{ req.student.get_full_name }}</td>
            <td>{{ req.get_title_display|truncatechars:30 }}</td>

            <!-- סטטוס -->
            <td>
              {% if req.status == 0 %}
                <i class="fas fa-hourglass-half text-muted"></i> ממתין
              {% elif req.status == 1 %}
                <i class="fas fa-check-circle text-success"></i> מאושר
              {% else %}
                <i class="fas fa-times-circle text-danger"></i> נדחה
              {% endif %}
            </td>

            <!-- זמן לטיפול -->
            <td>
              {% if req.status == 0 %}
                {{ req.get_remaining_days_display|safe }}
              {% else %}
                טופל
              {% endif %}
            </td>

            <!-- פעולות -->
            <td>
              <a href="{% url 'request_detail' req.id %}" class="btn btn-link text-decoration-none" title="צפה">
                <i class="fas fa-eye text-primary"></i>
              </a>
              {% if user.role == 1 or user.role == 2 or user.role == 3 %}
              <a href="{% url 'update_request_status' req.id %}" class="btn btn-link text-decoration-none" title="עדכון">
                <i class="fas fa-pen text-warning"></i>
              </a>
              <button type="submit" name="delete_request_id" value="{{ req.id }}" class="btn btn-link text-decoration-none" onclick="return confirm('האם למחוק את הבקשה?');" title="מחק">
                <i class="fas fa-trash text-danger"></i>
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
          </tbody>
        </table>
      </div>
    </form>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('sortable-table');
    if (table) new Tablesort(table);
  });

  document.addEventListener("DOMContentLoaded", function () {
    const titleInput = document.getElementById("searchTitle");
    const statusFilter = document.getElementById("statusFilter");
    const priorityFilter = document.getElementById("priorityFilter");

    function filterTable() {
      const title = titleInput.value.toLowerCase();
      const status = statusFilter.value;
      const priority = priorityFilter.value;
      const rows = document.querySelectorAll("#sortable-table tbody tr");

      rows.forEach((row) => {
        const titleText = row.children[2].textContent.toLowerCase();
        const statusText = row.children[3].textContent.trim();
        const priorityText = row.children[4].textContent.trim();

        const matchTitle = titleText.includes(title);
        const matchStatus = !status || statusText === status;
        const matchPriority = !priority || priorityText === priority;

        row.style.display = matchTitle && matchStatus && matchPriority ? "" : "none";
      });
    }

    titleInput.addEventListener("input", filterTable);
    statusFilter.addEventListener("change", filterTable);
    priorityFilter.addEventListener("change", filterTable);
  });

const ctx = document.getElementById('statusChart');

if (ctx) {
  const statusCounts = [
    {{ status_counts.0 }},
    {{ status_counts.1 }},
    {{ status_counts.2 }}
  ];

  const hasData = statusCounts.some(count => count > 0);

  const chartData = hasData
    ? {
        labels: ['ממתין', 'מאושר', 'נדחה'],
        datasets: [{
          data: statusCounts,
          backgroundColor: ['#dcd767', '#39a653', '#e6959c'],
          borderColor: ['#ffffff', '#ffffff', '#ffffff'],
          borderWidth: 2
        }]
      }
    : {
        labels: ['אין בקשות'],
        datasets: [{
          data: [1],
          backgroundColor: ['#ffffff'],
          borderColor: ['#000000'],
          borderWidth: 2
        }]
      };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: hasData,
        position: 'bottom'
      },
      tooltip: {
        enabled: hasData
      }
    }
  };

  new Chart(ctx, {
    type: 'doughnut',
    data: chartData,
    options: chartOptions
  });
}


</script>
{% endblock %}
